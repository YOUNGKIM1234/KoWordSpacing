Ch 10: Concept 04
================

Loading packages
================

``` r
library(tensorflow)
library(hashmap)
library(wordVectors)
library(caret)
```

    ## Loading required package: lattice

    ## Loading required package: ggplot2

``` r
library(stringr)
library(stringi)
library(data.table)

specl_char <- '⊙'
```

Making Character Vector features
================================

``` r
corpus <- readLines(bzfile("input.txt.bz2"))

corpus_cl <- stri_replace_all_regex(stri_trans_nfkc(corpus), pattern = '[:blank:]', replacement = '')

corpus_cl_split <- lapply(corpus_cl, function(x){
   paste(str_split(x, pattern = '')[[1]], collapse = ' ')
})

a <- lapply(corpus_cl_split, function(x){str_split(x, pattern = ' ')[[1]]})
tbl_a <- table(unlist(a))
summary(as.numeric(tbl_a))
```

    ##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
    ##      1.0      2.0      7.0    764.4     75.0 107351.0

``` r
#빈도 분포 확인 후 7회 이하 빈도는 다른 문자로 대체 
length(tbl_a[tbl_a < 7])
```

    ## [1] 2034

``` r
pat <- paste0('[', paste0(Filter(function(x) {nchar(x) == 1}, names(tbl_a[tbl_a < 7])),  collapse = ''), ']')


replaced_sent <- lapply(corpus_cl_split, function(x){str_replace(x, pattern = pat, replacement = specl_char)})


writeLines(unlist(replaced_sent), 'sejong_char_seq.txt')

w2v_model <- train_word2vec("sejong_char_seq.txt","sejong_char_seq.bin",
                       vectors=100,threads=8,window=10,iter=10,negative_samples=10, force=T)
```

    ## Starting training using file /home/gogamza/work/KoWordSpacing/sejong_char_seq.txt
    ## 100K
    200K
    300K
    400K
    500K
    600K
    700K
    800K
    900K
    1000K
    1100K
    1200K
    1300K
    1400K
    1500K
    1600K
    1700K
    1800K
    1900K
    2000K
    2100K
    2200K
    2300K
    2400K
    2500K
    2600K
    2700K
    2800K
    2900K
    3000K
    3100K
    3200K
    3300K
    Vocab size: 2193
    ## Words in train file: 3301038

    ## Filename ends with .bin, so reading in binary format

    ## Reading a word2vec binary file of 2193 rows and 100 columns

    ## 
      |                                                                       
      |                                                                 |   0%
      |                                                                       
      |                                                                 |   1%
      |                                                                       
      |=                                                                |   1%
      |                                                                       
      |=                                                                |   2%
      |                                                                       
      |==                                                               |   2%
      |                                                                       
      |==                                                               |   3%
      |                                                                       
      |==                                                               |   4%
      |                                                                       
      |===                                                              |   4%
      |                                                                       
      |===                                                              |   5%
      |                                                                       
      |====                                                             |   5%
      |                                                                       
      |====                                                             |   6%
      |                                                                       
      |====                                                             |   7%
      |                                                                       
      |=====                                                            |   7%
      |                                                                       
      |=====                                                            |   8%
      |                                                                       
      |======                                                           |   8%
      |                                                                       
      |======                                                           |   9%
      |                                                                       
      |======                                                           |  10%
      |                                                                       
      |=======                                                          |  10%
      |                                                                       
      |=======                                                          |  11%
      |                                                                       
      |=======                                                          |  12%
      |                                                                       
      |========                                                         |  12%
      |                                                                       
      |========                                                         |  13%
      |                                                                       
      |=========                                                        |  13%
      |                                                                       
      |=========                                                        |  14%
      |                                                                       
      |=========                                                        |  15%
      |                                                                       
      |==========                                                       |  15%
      |                                                                       
      |==========                                                       |  16%
      |                                                                       
      |===========                                                      |  16%
      |                                                                       
      |===========                                                      |  17%
      |                                                                       
      |===========                                                      |  18%
      |                                                                       
      |============                                                     |  18%
      |                                                                       
      |============                                                     |  19%
      |                                                                       
      |=============                                                    |  19%
      |                                                                       
      |=============                                                    |  20%
      |                                                                       
      |=============                                                    |  21%
      |                                                                       
      |==============                                                   |  21%
      |                                                                       
      |==============                                                   |  22%
      |                                                                       
      |===============                                                  |  22%
      |                                                                       
      |===============                                                  |  23%
      |                                                                       
      |===============                                                  |  24%
      |                                                                       
      |================                                                 |  24%
      |                                                                       
      |================                                                 |  25%
      |                                                                       
      |=================                                                |  25%
      |                                                                       
      |=================                                                |  26%
      |                                                                       
      |=================                                                |  27%
      |                                                                       
      |==================                                               |  27%
      |                                                                       
      |==================                                               |  28%
      |                                                                       
      |===================                                              |  28%
      |                                                                       
      |===================                                              |  29%
      |                                                                       
      |===================                                              |  30%
      |                                                                       
      |====================                                             |  30%
      |                                                                       
      |====================                                             |  31%
      |                                                                       
      |====================                                             |  32%
      |                                                                       
      |=====================                                            |  32%
      |                                                                       
      |=====================                                            |  33%
      |                                                                       
      |======================                                           |  33%
      |                                                                       
      |======================                                           |  34%
      |                                                                       
      |======================                                           |  35%
      |                                                                       
      |=======================                                          |  35%
      |                                                                       
      |=======================                                          |  36%
      |                                                                       
      |========================                                         |  36%
      |                                                                       
      |========================                                         |  37%
      |                                                                       
      |========================                                         |  38%
      |                                                                       
      |=========================                                        |  38%
      |                                                                       
      |=========================                                        |  39%
      |                                                                       
      |==========================                                       |  39%
      |                                                                       
      |==========================                                       |  40%
      |                                                                       
      |==========================                                       |  41%
      |                                                                       
      |===========================                                      |  41%
      |                                                                       
      |===========================                                      |  42%
      |                                                                       
      |============================                                     |  42%
      |                                                                       
      |============================                                     |  43%
      |                                                                       
      |============================                                     |  44%
      |                                                                       
      |=============================                                    |  44%
      |                                                                       
      |=============================                                    |  45%
      |                                                                       
      |==============================                                   |  45%
      |                                                                       
      |==============================                                   |  46%
      |                                                                       
      |==============================                                   |  47%
      |                                                                       
      |===============================                                  |  47%
      |                                                                       
      |===============================                                  |  48%
      |                                                                       
      |================================                                 |  48%
      |                                                                       
      |================================                                 |  49%
      |                                                                       
      |================================                                 |  50%
      |                                                                       
      |=================================                                |  50%
      |                                                                       
      |=================================                                |  51%
      |                                                                       
      |=================================                                |  52%
      |                                                                       
      |==================================                               |  52%
      |                                                                       
      |==================================                               |  53%
      |                                                                       
      |===================================                              |  53%
      |                                                                       
      |===================================                              |  54%
      |                                                                       
      |===================================                              |  55%
      |                                                                       
      |====================================                             |  55%
      |                                                                       
      |====================================                             |  56%
      |                                                                       
      |=====================================                            |  56%
      |                                                                       
      |=====================================                            |  57%
      |                                                                       
      |=====================================                            |  58%
      |                                                                       
      |======================================                           |  58%
      |                                                                       
      |======================================                           |  59%
      |                                                                       
      |=======================================                          |  59%
      |                                                                       
      |=======================================                          |  60%
      |                                                                       
      |=======================================                          |  61%
      |                                                                       
      |========================================                         |  61%
      |                                                                       
      |========================================                         |  62%
      |                                                                       
      |=========================================                        |  62%
      |                                                                       
      |=========================================                        |  63%
      |                                                                       
      |=========================================                        |  64%
      |                                                                       
      |==========================================                       |  64%
      |                                                                       
      |==========================================                       |  65%
      |                                                                       
      |===========================================                      |  65%
      |                                                                       
      |===========================================                      |  66%
      |                                                                       
      |===========================================                      |  67%
      |                                                                       
      |============================================                     |  67%
      |                                                                       
      |============================================                     |  68%
      |                                                                       
      |=============================================                    |  68%
      |                                                                       
      |=============================================                    |  69%
      |                                                                       
      |=============================================                    |  70%
      |                                                                       
      |==============================================                   |  70%
      |                                                                       
      |==============================================                   |  71%
      |                                                                       
      |==============================================                   |  72%
      |                                                                       
      |===============================================                  |  72%
      |                                                                       
      |===============================================                  |  73%
      |                                                                       
      |================================================                 |  73%
      |                                                                       
      |================================================                 |  74%
      |                                                                       
      |================================================                 |  75%
      |                                                                       
      |=================================================                |  75%
      |                                                                       
      |=================================================                |  76%
      |                                                                       
      |==================================================               |  76%
      |                                                                       
      |==================================================               |  77%
      |                                                                       
      |==================================================               |  78%
      |                                                                       
      |===================================================              |  78%
      |                                                                       
      |===================================================              |  79%
      |                                                                       
      |====================================================             |  79%
      |                                                                       
      |====================================================             |  80%
      |                                                                       
      |====================================================             |  81%
      |                                                                       
      |=====================================================            |  81%
      |                                                                       
      |=====================================================            |  82%
      |                                                                       
      |======================================================           |  82%
      |                                                                       
      |======================================================           |  83%
      |                                                                       
      |======================================================           |  84%
      |                                                                       
      |=======================================================          |  84%
      |                                                                       
      |=======================================================          |  85%
      |                                                                       
      |========================================================         |  85%
      |                                                                       
      |========================================================         |  86%
      |                                                                       
      |========================================================         |  87%
      |                                                                       
      |=========================================================        |  87%
      |                                                                       
      |=========================================================        |  88%
      |                                                                       
      |==========================================================       |  88%
      |                                                                       
      |==========================================================       |  89%
      |                                                                       
      |==========================================================       |  90%
      |                                                                       
      |===========================================================      |  90%
      |                                                                       
      |===========================================================      |  91%
      |                                                                       
      |===========================================================      |  92%
      |                                                                       
      |============================================================     |  92%
      |                                                                       
      |============================================================     |  93%
      |                                                                       
      |=============================================================    |  93%
      |                                                                       
      |=============================================================    |  94%
      |                                                                       
      |=============================================================    |  95%
      |                                                                       
      |==============================================================   |  95%
      |                                                                       
      |==============================================================   |  96%
      |                                                                       
      |===============================================================  |  96%
      |                                                                       
      |===============================================================  |  97%
      |                                                                       
      |===============================================================  |  98%
      |                                                                       
      |================================================================ |  98%
      |                                                                       
      |================================================================ |  99%
      |                                                                       
      |=================================================================|  99%
      |                                                                       
      |=================================================================| 100%

Korean word spacing RNN
=======================

``` r
#analyze to extract word spacing info.
# makeCorpus("옷을 만드느라 늘")
#$status
# [1] 0 1 0 0 0 1 1
# 
# $char
# [1] "옷" "을" "만" "드" "느" "라" "늘"
# 
# $nchar
# [1] 7
makeCorpus <- function(str){
  strv <- strsplit(str,split="")[[1]]
  lenstrv <- length(strv)
  spacev <- vector(mode="numeric",length=lenstrv)
  charv  <- vector(mode="character",length=lenstrv)
  vidx <- 1
  for(i in 1:lenstrv){
    if(strv[i] == " ") {
      next
    }
    if(i + 1 <= lenstrv && strv[i + 1] == " "){
      spacev[vidx] <- 1
    }else{
      if(i == lenstrv){
        spacev[vidx] <- 1
      }else{
        spacev[vidx] <- 0
      }
    }
    charv[vidx] <- strv[i]
    vidx <- vidx + 1
  }
  charv_f <- Filter(function(x){x!=''},charv)
  status <- spacev[1:length(charv_f)]
  char <- charv_f
  nchar <-length(charv_f)
  return(list(status=status, char=char, nchar=nchar))
}

#read word2vector object 
m <- read.vectors("sejong_char_seq.bin")
```

    ## Filename ends with .bin, so reading in binary format

    ## Reading a word2vec binary file of 2193 rows and 100 columns

    ## 
      |                                                                       
      |                                                                 |   0%
      |                                                                       
      |                                                                 |   1%
      |                                                                       
      |=                                                                |   1%
      |                                                                       
      |=                                                                |   2%
      |                                                                       
      |==                                                               |   2%
      |                                                                       
      |==                                                               |   3%
      |                                                                       
      |==                                                               |   4%
      |                                                                       
      |===                                                              |   4%
      |                                                                       
      |===                                                              |   5%
      |                                                                       
      |====                                                             |   5%
      |                                                                       
      |====                                                             |   6%
      |                                                                       
      |====                                                             |   7%
      |                                                                       
      |=====                                                            |   7%
      |                                                                       
      |=====                                                            |   8%
      |                                                                       
      |======                                                           |   8%
      |                                                                       
      |======                                                           |   9%
      |                                                                       
      |======                                                           |  10%
      |                                                                       
      |=======                                                          |  10%
      |                                                                       
      |=======                                                          |  11%
      |                                                                       
      |=======                                                          |  12%
      |                                                                       
      |========                                                         |  12%
      |                                                                       
      |========                                                         |  13%
      |                                                                       
      |=========                                                        |  13%
      |                                                                       
      |=========                                                        |  14%
      |                                                                       
      |=========                                                        |  15%
      |                                                                       
      |==========                                                       |  15%
      |                                                                       
      |==========                                                       |  16%
      |                                                                       
      |===========                                                      |  16%
      |                                                                       
      |===========                                                      |  17%
      |                                                                       
      |===========                                                      |  18%
      |                                                                       
      |============                                                     |  18%
      |                                                                       
      |============                                                     |  19%
      |                                                                       
      |=============                                                    |  19%
      |                                                                       
      |=============                                                    |  20%
      |                                                                       
      |=============                                                    |  21%
      |                                                                       
      |==============                                                   |  21%
      |                                                                       
      |==============                                                   |  22%
      |                                                                       
      |===============                                                  |  22%
      |                                                                       
      |===============                                                  |  23%
      |                                                                       
      |===============                                                  |  24%
      |                                                                       
      |================                                                 |  24%
      |                                                                       
      |================                                                 |  25%
      |                                                                       
      |=================                                                |  25%
      |                                                                       
      |=================                                                |  26%
      |                                                                       
      |=================                                                |  27%
      |                                                                       
      |==================                                               |  27%
      |                                                                       
      |==================                                               |  28%
      |                                                                       
      |===================                                              |  28%
      |                                                                       
      |===================                                              |  29%
      |                                                                       
      |===================                                              |  30%
      |                                                                       
      |====================                                             |  30%
      |                                                                       
      |====================                                             |  31%
      |                                                                       
      |====================                                             |  32%
      |                                                                       
      |=====================                                            |  32%
      |                                                                       
      |=====================                                            |  33%
      |                                                                       
      |======================                                           |  33%
      |                                                                       
      |======================                                           |  34%
      |                                                                       
      |======================                                           |  35%
      |                                                                       
      |=======================                                          |  35%
      |                                                                       
      |=======================                                          |  36%
      |                                                                       
      |========================                                         |  36%
      |                                                                       
      |========================                                         |  37%
      |                                                                       
      |========================                                         |  38%
      |                                                                       
      |=========================                                        |  38%
      |                                                                       
      |=========================                                        |  39%
      |                                                                       
      |==========================                                       |  39%
      |                                                                       
      |==========================                                       |  40%
      |                                                                       
      |==========================                                       |  41%
      |                                                                       
      |===========================                                      |  41%
      |                                                                       
      |===========================                                      |  42%
      |                                                                       
      |============================                                     |  42%
      |                                                                       
      |============================                                     |  43%
      |                                                                       
      |============================                                     |  44%
      |                                                                       
      |=============================                                    |  44%
      |                                                                       
      |=============================                                    |  45%
      |                                                                       
      |==============================                                   |  45%
      |                                                                       
      |==============================                                   |  46%
      |                                                                       
      |==============================                                   |  47%
      |                                                                       
      |===============================                                  |  47%
      |                                                                       
      |===============================                                  |  48%
      |                                                                       
      |================================                                 |  48%
      |                                                                       
      |================================                                 |  49%
      |                                                                       
      |================================                                 |  50%
      |                                                                       
      |=================================                                |  50%
      |                                                                       
      |=================================                                |  51%
      |                                                                       
      |=================================                                |  52%
      |                                                                       
      |==================================                               |  52%
      |                                                                       
      |==================================                               |  53%
      |                                                                       
      |===================================                              |  53%
      |                                                                       
      |===================================                              |  54%
      |                                                                       
      |===================================                              |  55%
      |                                                                       
      |====================================                             |  55%
      |                                                                       
      |====================================                             |  56%
      |                                                                       
      |=====================================                            |  56%
      |                                                                       
      |=====================================                            |  57%
      |                                                                       
      |=====================================                            |  58%
      |                                                                       
      |======================================                           |  58%
      |                                                                       
      |======================================                           |  59%
      |                                                                       
      |=======================================                          |  59%
      |                                                                       
      |=======================================                          |  60%
      |                                                                       
      |=======================================                          |  61%
      |                                                                       
      |========================================                         |  61%
      |                                                                       
      |========================================                         |  62%
      |                                                                       
      |=========================================                        |  62%
      |                                                                       
      |=========================================                        |  63%
      |                                                                       
      |=========================================                        |  64%
      |                                                                       
      |==========================================                       |  64%
      |                                                                       
      |==========================================                       |  65%
      |                                                                       
      |===========================================                      |  65%
      |                                                                       
      |===========================================                      |  66%
      |                                                                       
      |===========================================                      |  67%
      |                                                                       
      |============================================                     |  67%
      |                                                                       
      |============================================                     |  68%
      |                                                                       
      |=============================================                    |  68%
      |                                                                       
      |=============================================                    |  69%
      |                                                                       
      |=============================================                    |  70%
      |                                                                       
      |==============================================                   |  70%
      |                                                                       
      |==============================================                   |  71%
      |                                                                       
      |==============================================                   |  72%
      |                                                                       
      |===============================================                  |  72%
      |                                                                       
      |===============================================                  |  73%
      |                                                                       
      |================================================                 |  73%
      |                                                                       
      |================================================                 |  74%
      |                                                                       
      |================================================                 |  75%
      |                                                                       
      |=================================================                |  75%
      |                                                                       
      |=================================================                |  76%
      |                                                                       
      |==================================================               |  76%
      |                                                                       
      |==================================================               |  77%
      |                                                                       
      |==================================================               |  78%
      |                                                                       
      |===================================================              |  78%
      |                                                                       
      |===================================================              |  79%
      |                                                                       
      |====================================================             |  79%
      |                                                                       
      |====================================================             |  80%
      |                                                                       
      |====================================================             |  81%
      |                                                                       
      |=====================================================            |  81%
      |                                                                       
      |=====================================================            |  82%
      |                                                                       
      |======================================================           |  82%
      |                                                                       
      |======================================================           |  83%
      |                                                                       
      |======================================================           |  84%
      |                                                                       
      |=======================================================          |  84%
      |                                                                       
      |=======================================================          |  85%
      |                                                                       
      |========================================================         |  85%
      |                                                                       
      |========================================================         |  86%
      |                                                                       
      |========================================================         |  87%
      |                                                                       
      |=========================================================        |  87%
      |                                                                       
      |=========================================================        |  88%
      |                                                                       
      |==========================================================       |  88%
      |                                                                       
      |==========================================================       |  89%
      |                                                                       
      |==========================================================       |  90%
      |                                                                       
      |===========================================================      |  90%
      |                                                                       
      |===========================================================      |  91%
      |                                                                       
      |===========================================================      |  92%
      |                                                                       
      |============================================================     |  92%
      |                                                                       
      |============================================================     |  93%
      |                                                                       
      |=============================================================    |  93%
      |                                                                       
      |=============================================================    |  94%
      |                                                                       
      |=============================================================    |  95%
      |                                                                       
      |==============================================================   |  95%
      |                                                                       
      |==============================================================   |  96%
      |                                                                       
      |===============================================================  |  96%
      |                                                                       
      |===============================================================  |  97%
      |                                                                       
      |===============================================================  |  98%
      |                                                                       
      |================================================================ |  98%
      |                                                                       
      |================================================================ |  99%
      |                                                                       
      |=================================================================|  99%
      |                                                                       
      |=================================================================| 100%

``` r
# read corpus
sents <-readLines(bzfile('input.txt.bz2'),encoding='UTF-8')


#3어절씩 문장을 만든다. 
sents_eojeol <- str_split(stri_trans_nfkc(sents), pattern = '[:blank:]')
wordchunk <- lapply(sents_eojeol, function(x){
  x <- Filter(function(y){y != ''}, x)
  v <- c()
  k <- 3
  if(length(x) < k) return(paste( x,collapse = " "))
  
  for(i in 1:length(x)){
    if((i + k - 1) > length(x)) break
    v <- c(v, paste(x[i:(i + k - 1)], collapse = " "))
  }
  return(v)
  })
```

    ## Warning in paste(x[i:(i + k - 1)], collapse = " "): closing unused
    ## connection 5 (input.txt.bz2)

``` r
wordchunk <- unlist(wordchunk)

space_coding  <- lapply(wordchunk, makeCorpus)

#extract each word chunk length
charsents <- lapply(space_coding, function(x){x$char})
uniq_chars <- unique(unlist(charsents))
max_seq_len <- max(unlist(lapply(space_coding, function(x){x$nchar})))

#make sentence coding 
seq_mat_x <- matrix(0, ncol=max_seq_len, nrow=length(wordchunk))

#make hash map to extract row index of m
chmap <- hashmap(rownames(m), 0:(nrow(m)-1))

for(i in 1:length(wordchunk)){
  sent <- space_coding[[i]]$char
  for(j in 1:length(sent)){
    idx <- chmap[[sent[j]]]
    if(is.na(idx)) idx <- chmap[[specl_char]]
    seq_mat_x[i,j] <- idx
  }
}


seq_mat_y <- matrix(0, ncol=max_seq_len, nrow=length(wordchunk))
loss_mask <-matrix(0, ncol=max_seq_len, nrow=length(wordchunk))

for(i in 1:length(wordchunk)){
  sent <- space_coding[[i]]$status
  for(j in 1:length(sent)){
    seq_mat_y[i,j] <- sent[j] 
    loss_mask[i,j] <- 1
  }
}


len_list <-  unlist(lapply(space_coding, function(x){x$nchar}))
sent_chars <- lapply(space_coding, function(x){x$char})
```

``` r
library(R6)

WordSpacing <- R6Class("WordSpacing",
    public = list(
      char_dic_size=NULL, 
      n_neurons=NULL, 
      num_classes=NULL, 
      batch_size=NULL,
      sequence_length=NULL, 
      word_spacing_graph=NULL,
      config_proto=NULL, 
      mem_fraction=NULL, 
      x=NULL, y=NULL, 
      sent_len=NULL, loss=NULL, prediction=NULL, optimizer=NULL,
      init=NULL, saver=NULL, global_step=NULL, num_out_classes=NULL,weight_mask=NULL,
      c2v=NULL, embeddings=NULL, seg_loss=NULL, accuracy=NULL,chmap=NULL,
      
      initialize=function(char_dic_size, n_neurons, num_classes, num_out_classes, sequence_length,c2v, mem_fraction=0.999,global_step = 1L){
        self$char_dic_size <- as.integer(char_dic_size)
        self$n_neurons <- as.integer(n_neurons)
        self$num_classes <- as.integer(num_classes)
        self$num_out_classes <- as.integer(num_out_classes)
        self$sequence_length <- as.integer(sequence_length)
        self$global_step <- as.integer(global_step)
        self$c2v <- c2v
        #self$is_training <- FALSE
        self$chmap <- hashmap(rownames(self$c2v), 0:(nrow(self$c2v)-1))
        
        
        
        gpu_options <- tf$GPUOptions(per_process_gpu_memory_fraction=mem_fraction)
        self$config_proto <- tf$ConfigProto(allow_soft_placement=T,log_device_placement=F, gpu_options=gpu_options)
        
        self$word_spacing_graph <- tf$Graph()
        
        with(self$word_spacing_graph$as_default(), {
          with(tf$name_scope("kor_word_spacing"),{
            with(tf$device("/gpu:0"), {
              #variable
              self$x <- tf$placeholder(tf$int32, list(NULL, self$sequence_length), name='x') 
              self$embeddings <- tf$placeholder(tf$float32, list(self$char_dic_size, self$num_classes), name='embeddings')
              self$y <- tf$placeholder(tf$int32, list(NULL, self$sequence_length), name='y')  
              self$weight_mask <- tf$placeholder(tf$float32, list(NULL, self$sequence_length), name='weight_mask') 
              self$sent_len <- tf$placeholder(tf$int32, list(NULL), name='sent_len')  
              self$batch_size <-  tf$placeholder(tf$int32, shape = list(), name='batch_size')

            })              
            with(tf$device("/gpu:1"), {

              with(tf$name_scope('rnn_cell'),{
                x_emb <- tf$nn$embedding_lookup(self$embeddings, self$x)
                
                cell <- tf$contrib$rnn$BasicLSTMCell(num_units=self$n_neurons)
                
                initial_state <- cell$zero_state(self$batch_size, tf$float32)
                outputs_states <- tf$nn$dynamic_rnn(cell = cell,inputs = x_emb, sequence_length=self$sent_len,
                                     dtype=tf$float32,initial_state = initial_state)
              }) 
              
              with(tf$name_scope('fc1'),{
                x_fc <- tf$reshape(outputs_states[[1]], list(-1L, self$n_neurons))
                fc_w <- tf$get_variable("fc_w", list(self$n_neurons,
                                                     self$num_out_classes),
                                        initializer=tf$contrib$layers$xavier_initializer())
                fc_b <- tf$get_variable("fc_b", list(self$num_out_classes),
                                        initializer=tf$random_normal_initializer())
                fc1 <-  tf$matmul(x_fc, fc_w) + fc_b
              })
              
              l2_losses <- tf$reduce_sum(tf$abs(fc_w)) 
  
              # reshape out for sequence_loss
              outputs <- tf$reshape(fc1, list(-1L, self$sequence_length,
                                              self$num_out_classes))
              #weights <- tf$ones_like(self$x, dtype = tf$float32)
              self$prediction <- tf$argmax(outputs, axis=2L, name = 'prediction')
              
              pred_num_seg <- tf$cast(tf$reduce_sum(self$prediction,axis = 1L), dtype = tf$float32)
              y_num_seg   <- tf$cast(tf$reduce_sum(self$y, axis=1L), dtype = tf$float32)
              self$seg_loss <- tf$reduce_mean(tf$abs(pred_num_seg-y_num_seg) / tf$cast(self$sent_len, dtype = tf$float32))
              
              sequence_loss <- tf$contrib$seq2seq$sequence_loss(
                  logits=outputs, targets=self$y, weights=self$weight_mask)
              self$loss <- tf$reduce_mean(sequence_loss, name = 'loss')
              lambda <- tf$constant(0.15, dtype = tf$float32)
              
              self$optimizer <- tf$train$AdamOptimizer(learning_rate=0.0005)$minimize(
                self$loss + (lambda * self$seg_loss) + (0.0001 * l2_losses), name='optimizer')
              
              correct_prediction <- tf$equal(tf$cast(self$prediction, tf$int32), self$y)
              self$accuracy <- tf$reduce_mean(tf$cast(correct_prediction, tf$float32))
              
              # Define a saver op
              self$init <- tf$global_variables_initializer()
              self$saver <- tf$train$Saver(max_to_keep=0L, name='saver')
            })
          })
          
        })
      }, 
      train = function(seq_mat_x, seq_mat_y, sent_len_x, loss_mask, batch_n, epoch=10L){
        tr_idx <- 1:(0.95 * nrow(seq_mat_x))
        
        seq_mat_x_train <- seq_mat_x[tr_idx, ]
        seq_mat_x_test <- seq_mat_x[-tr_idx, ]
        
        seq_mat_y_train <- seq_mat_y[tr_idx, ]
        seq_mat_y_test <- seq_mat_y[-tr_idx, ]
        len_list_train <- sent_len_x[tr_idx]
        len_list_test <- sent_len_x[-tr_idx]
        loss_mask_train <-  loss_mask[tr_idx, ]
        loss_mask_test <-  loss_mask[-tr_idx, ]

        loss_v <- c()
        loss_vt <- c()
        #self$is_training <- TRUE
        

        x <- self$x
        embeddings <- self$embeddings
        y <- self$y
        sent_len <- self$sent_len
        batch_size <- self$batch_size
        weight_mask <- self$weight_mask
        c2v <- self$c2v
        
        with(tf$Session(config=self$config_proto, graph=self$word_spacing_graph) %as% sess, {
          sess$run(self$init)
          for(i in 1:epoch){
            #shufle 
            rnd_idx <- sample(1:nrow(seq_mat_x_train), nrow(seq_mat_x_train))
            
            seq_mat_x_ <- seq_mat_x_train[rnd_idx,]
            seq_mat_y_ <- seq_mat_y_train[rnd_idx,]
            sent_len_x_ <- len_list_train[rnd_idx]
            loss_mask_ <- loss_mask_train[rnd_idx,]
            
            j <- 0
            for(k in seq(1, nrow(seq_mat_x_train), batch_n)){
              if( k + batch_n - 1 > nrow(seq_mat_x_train)){
                bat_size <- nrow(seq_mat_x_train)  + 1 - k
              }else{
                bat_size <- batch_n
              }
              self$c2v
              l <- sess$run(list(self$loss, self$optimizer, self$seg_loss, self$accuracy), feed_dict=
                                dict(
                                    x=matrix(seq_mat_x_[k:(k + bat_size - 1),], byrow=T, nrow=bat_size),
                                    embeddings=c2v, 
                                    y= matrix(seq_mat_y_[k:(k + bat_size - 1),], byrow=T, nrow=bat_size), 
                                    sent_len= sent_len_x_[k:(k + bat_size - 1)],
                                    batch_size=as.integer(bat_size),
                                    weight_mask=matrix(loss_mask_[k:(k + bat_size - 1),], byrow=T, nrow=bat_size)
                                ))
              j <- j + 1
              if(j %% 300 == 0){
                #self$is_training <- F
                print(sprintf("%d:%d train loss : %f, seg loss : %f, accuracy : %f", i, j, l[[1]], l[[3]], l[[4]]))
                loss_v <- c(loss_v, l[[1]])
                test_sent <- "아버지가방에들어가셨다."
                coding_mat <- self$sent_to_code(test_sent)
                result <- sess$run(self$prediction,
                                   feed_dict=dict(
                                                  x=coding_mat[[1]],
                                                  embeddings=c2v,
                                                  sent_len=list(coding_mat[[2]]),
                                                  batch_size=c(1L)))
                print(self$code_to_sent(test_sent, result, nchar(test_sent)))
                loss_eval <- sess$run(list(self$loss,self$accuracy), feed_dict=
                                dict(
                                     x=seq_mat_x_test,
                                     embeddings=c2v, 
                                     y= seq_mat_y_test, 
                                     sent_len= len_list_test,
                                     batch_size=as.integer(dim(seq_mat_x_test)[1]),
                                     weight_mask=loss_mask_test
                                ))
                print(sprintf("%d:%d test loss : %f, accuracy : %f", i, j, loss_eval[[1]], loss_eval[[2]]))
                loss_vt <- c(loss_vt, loss_eval[[1]])
                
              }
              #self$is_training <- T
            }
            #self$is_training <- F
            save_path <- self$saver$save(sess=sess, save_path = sprintf("model/model_%d.chkp", i),
                                    global_step =self$global_step)
            #self$is_training <- T
            print(sprintf("Model saved in file: %s",  save_path))
          }
          
        })
        return(list(loss_v, loss_vt))
      },
      predict = function(test_sent, best_epoc, glob_step=1L){
        x <- self$x
        embeddings <- self$embeddings
        sent_len <- self$sent_len
        batch_size <- self$batch_size
        coding_mat <- self$sent_to_code(test_sent)
        with(tf$Session(config=self$config_proto, graph=self$word_spacing_graph) %as% sess, {
          self$saver$restore(sess, sprintf("model/model_%d.chkp-%d",best_epoc, glob_step))
          #self$is_training <- F
          preds <- sess$run(self$prediction,feed_dict=dict(
                                                            x=coding_mat[[1]],
                                                            embeddings=self$c2v, 
                                                            sent_len=list(coding_mat[[2]]), 
                                                            batch_size=c(1L)))
        })
        
        return(self$code_to_sent(test_sent, preds, nchar(test_sent)))
      },
      code_to_sent=function(input_sent, coding_mat, coding_len){
        char_sent <- str_split(input_sent, '')[[1]]
        ch <- c()
        for(i in 1:coding_len){
          if(coding_mat[1,i] == 1){
            ch <- c(ch, char_sent[i] ,' ')
          }else{
            ch <- c(ch, char_sent[i])
          }
        }
        return(paste0(ch, collapse = ''))
      },
      sent_to_code=function(sentence){
        seq_mat_test <- matrix(0, ncol=max_seq_len, nrow=1)
  
        sent_t <- str_split(sentence, pattern = '')[[1]]
        for(j in 1:length(sent_t)){
          idx <- self$chmap[[sent_t[j]]]
          if(is.na(idx)) idx <- self$chmap[[specl_char]]
          seq_mat_test[1,j] <- idx
        }
        return(list(seq_mat_x=seq_mat_test, nchar=nchar(sentence)))
      }
))
```

``` r
wsp <- WordSpacing$new(char_dic_size=dim(m)[1], n_neurons=10L, num_out_classes=2L, 
                       num_classes=100L, 
                       sequence_length=max_seq_len, c2v=m, global_step = 1L)


tr_loss <- wsp$train(seq_mat_x, seq_mat_y, len_list,loss_mask, batch_n=100L, epoch = 3)
```

    ## [1] "1:300 train loss : 0.603783, seg loss : 0.300639, accuracy : 0.969369"
    ## [1] "아버지가방에들어가셨다. "
    ## [1] "1:300 test loss : 0.539643, accuracy : 0.974559"
    ## [1] "1:600 train loss : 0.606055, seg loss : 0.334303, accuracy : 0.969474"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:600 test loss : 0.444694, accuracy : 0.981696"
    ## [1] "1:900 train loss : 0.607374, seg loss : 0.269314, accuracy : 0.969263"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:900 test loss : 0.422816, accuracy : 0.982779"
    ## [1] "1:1200 train loss : 0.589316, seg loss : 0.290103, accuracy : 0.971158"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:1200 test loss : 0.414693, accuracy : 0.982890"
    ## [1] "1:1500 train loss : 0.607257, seg loss : 0.350851, accuracy : 0.969579"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:1500 test loss : 0.410727, accuracy : 0.982936"
    ## [1] "1:1800 train loss : 0.589590, seg loss : 0.239739, accuracy : 0.971053"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:1800 test loss : 0.410164, accuracy : 0.982730"
    ## [1] "1:2100 train loss : 0.601432, seg loss : 0.309062, accuracy : 0.970106"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:2100 test loss : 0.408696, accuracy : 0.982980"
    ## [1] "1:2400 train loss : 0.590798, seg loss : 0.286726, accuracy : 0.970316"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:2400 test loss : 0.406722, accuracy : 0.983002"
    ## [1] "1:2700 train loss : 0.610097, seg loss : 0.306024, accuracy : 0.969263"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:2700 test loss : 0.405270, accuracy : 0.982769"
    ## [1] "1:3000 train loss : 0.613903, seg loss : 0.321316, accuracy : 0.969263"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:3000 test loss : 0.402891, accuracy : 0.982650"
    ## [1] "1:3300 train loss : 0.604396, seg loss : 0.306050, accuracy : 0.970211"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "1:3300 test loss : 0.401054, accuracy : 0.982788"
    ## [1] "1:3600 train loss : 0.615828, seg loss : 0.358205, accuracy : 0.969263"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "1:3600 test loss : 0.400687, accuracy : 0.982914"
    ## [1] "1:3900 train loss : 0.599824, seg loss : 0.310835, accuracy : 0.969579"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:3900 test loss : 0.401413, accuracy : 0.982887"
    ## [1] "1:4200 train loss : 0.602103, seg loss : 0.331288, accuracy : 0.970421"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:4200 test loss : 0.398837, accuracy : 0.982883"
    ## [1] "1:4500 train loss : 0.605411, seg loss : 0.326487, accuracy : 0.970737"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "1:4500 test loss : 0.398369, accuracy : 0.982899"
    ## [1] "1:4800 train loss : 0.605060, seg loss : 0.347758, accuracy : 0.969474"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "1:4800 test loss : 0.398058, accuracy : 0.982809"
    ## [1] "1:5100 train loss : 0.614360, seg loss : 0.329227, accuracy : 0.969263"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:5100 test loss : 0.398054, accuracy : 0.982929"
    ## [1] "1:5400 train loss : 0.592779, seg loss : 0.260272, accuracy : 0.970000"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "1:5400 test loss : 0.396066, accuracy : 0.982971"
    ## [1] "1:5700 train loss : 0.603241, seg loss : 0.337553, accuracy : 0.969895"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:5700 test loss : 0.395883, accuracy : 0.983074"
    ## [1] "1:6000 train loss : 0.603489, seg loss : 0.367831, accuracy : 0.968948"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:6000 test loss : 0.399157, accuracy : 0.982871"
    ## [1] "1:6300 train loss : 0.599289, seg loss : 0.310165, accuracy : 0.970000"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "1:6300 test loss : 0.393981, accuracy : 0.982932"
    ## [1] "1:6600 train loss : 0.592676, seg loss : 0.291268, accuracy : 0.970211"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:6600 test loss : 0.397331, accuracy : 0.982813"
    ## [1] "1:6900 train loss : 0.593244, seg loss : 0.314826, accuracy : 0.969790"
    ## [1] "아버지가 방에 들어가 셨다. "
    ## [1] "1:6900 test loss : 0.394426, accuracy : 0.983009"
    ## [1] "1:7200 train loss : 0.592761, seg loss : 0.290725, accuracy : 0.969369"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "1:7200 test loss : 0.393490, accuracy : 0.982930"
    ## [1] "1:7500 train loss : 0.607959, seg loss : 0.390028, accuracy : 0.969369"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "1:7500 test loss : 0.393776, accuracy : 0.982750"
    ## [1] "1:7800 train loss : 0.593547, seg loss : 0.316555, accuracy : 0.970316"
    ## [1] "아버지가 방에 들어가 셨다. "
    ## [1] "1:7800 test loss : 0.394664, accuracy : 0.982903"
    ## [1] "Model saved in file: model/model_1.chkp-1"
    ## [1] "2:300 train loss : 0.603157, seg loss : 0.307674, accuracy : 0.969684"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "2:300 test loss : 0.391858, accuracy : 0.982972"
    ## [1] "2:600 train loss : 0.582560, seg loss : 0.297954, accuracy : 0.969158"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "2:600 test loss : 0.392789, accuracy : 0.982856"
    ## [1] "2:900 train loss : 0.590208, seg loss : 0.328610, accuracy : 0.969895"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "2:900 test loss : 0.393371, accuracy : 0.982622"
    ## [1] "2:1200 train loss : 0.627396, seg loss : 0.340286, accuracy : 0.970000"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "2:1200 test loss : 0.390669, accuracy : 0.982978"
    ## [1] "2:1500 train loss : 0.600638, seg loss : 0.270657, accuracy : 0.970000"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "2:1500 test loss : 0.390553, accuracy : 0.982918"
    ## [1] "2:1800 train loss : 0.597199, seg loss : 0.257437, accuracy : 0.970948"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:1800 test loss : 0.388941, accuracy : 0.983019"
    ## [1] "2:2100 train loss : 0.604777, seg loss : 0.266863, accuracy : 0.969790"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:2100 test loss : 0.390207, accuracy : 0.983016"
    ## [1] "2:2400 train loss : 0.588545, seg loss : 0.280328, accuracy : 0.970527"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "2:2400 test loss : 0.391695, accuracy : 0.982852"
    ## [1] "2:2700 train loss : 0.599193, seg loss : 0.339985, accuracy : 0.969685"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "2:2700 test loss : 0.389695, accuracy : 0.982932"
    ## [1] "2:3000 train loss : 0.604920, seg loss : 0.307473, accuracy : 0.969579"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:3000 test loss : 0.388950, accuracy : 0.983035"
    ## [1] "2:3300 train loss : 0.609273, seg loss : 0.333351, accuracy : 0.969790"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "2:3300 test loss : 0.391750, accuracy : 0.982966"
    ## [1] "2:3600 train loss : 0.610045, seg loss : 0.351455, accuracy : 0.969790"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "2:3600 test loss : 0.391322, accuracy : 0.982877"
    ## [1] "2:3900 train loss : 0.595671, seg loss : 0.295939, accuracy : 0.970000"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:3900 test loss : 0.387606, accuracy : 0.983012"
    ## [1] "2:4200 train loss : 0.603734, seg loss : 0.308600, accuracy : 0.970000"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:4200 test loss : 0.386651, accuracy : 0.983111"
    ## [1] "2:4500 train loss : 0.611019, seg loss : 0.318782, accuracy : 0.969158"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "2:4500 test loss : 0.389569, accuracy : 0.982940"
    ## [1] "2:4800 train loss : 0.580165, seg loss : 0.290425, accuracy : 0.970842"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "2:4800 test loss : 0.388684, accuracy : 0.982950"
    ## [1] "2:5100 train loss : 0.605182, seg loss : 0.351678, accuracy : 0.969579"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:5100 test loss : 0.387806, accuracy : 0.983089"
    ## [1] "2:5400 train loss : 0.602422, seg loss : 0.294746, accuracy : 0.970211"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:5400 test loss : 0.388157, accuracy : 0.983157"
    ## [1] "2:5700 train loss : 0.596333, seg loss : 0.292889, accuracy : 0.970000"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:5700 test loss : 0.387653, accuracy : 0.983098"
    ## [1] "2:6000 train loss : 0.605062, seg loss : 0.309807, accuracy : 0.969685"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:6000 test loss : 0.385745, accuracy : 0.983230"
    ## [1] "2:6300 train loss : 0.603874, seg loss : 0.368053, accuracy : 0.969369"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:6300 test loss : 0.388174, accuracy : 0.982964"
    ## [1] "2:6600 train loss : 0.599699, seg loss : 0.307723, accuracy : 0.970948"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:6600 test loss : 0.387212, accuracy : 0.983265"
    ## [1] "2:6900 train loss : 0.616537, seg loss : 0.302736, accuracy : 0.970106"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:6900 test loss : 0.385844, accuracy : 0.983171"
    ## [1] "2:7200 train loss : 0.591426, seg loss : 0.325249, accuracy : 0.970421"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:7200 test loss : 0.385935, accuracy : 0.983131"
    ## [1] "2:7500 train loss : 0.619652, seg loss : 0.320282, accuracy : 0.969684"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:7500 test loss : 0.388223, accuracy : 0.983009"
    ## [1] "2:7800 train loss : 0.597945, seg loss : 0.331573, accuracy : 0.970106"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "2:7800 test loss : 0.386868, accuracy : 0.982989"
    ## [1] "Model saved in file: model/model_2.chkp-1"
    ## [1] "3:300 train loss : 0.596883, seg loss : 0.281901, accuracy : 0.969263"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:300 test loss : 0.385435, accuracy : 0.983225"
    ## [1] "3:600 train loss : 0.572486, seg loss : 0.302097, accuracy : 0.971158"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:600 test loss : 0.384731, accuracy : 0.983187"
    ## [1] "3:900 train loss : 0.590659, seg loss : 0.316263, accuracy : 0.970106"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "3:900 test loss : 0.385248, accuracy : 0.983173"
    ## [1] "3:1200 train loss : 0.606536, seg loss : 0.329375, accuracy : 0.970316"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:1200 test loss : 0.384335, accuracy : 0.983262"
    ## [1] "3:1500 train loss : 0.584983, seg loss : 0.318371, accuracy : 0.969895"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:1500 test loss : 0.385547, accuracy : 0.983170"
    ## [1] "3:1800 train loss : 0.609365, seg loss : 0.310289, accuracy : 0.970316"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:1800 test loss : 0.384881, accuracy : 0.983150"
    ## [1] "3:2100 train loss : 0.593905, seg loss : 0.352139, accuracy : 0.970948"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:2100 test loss : 0.385940, accuracy : 0.983149"
    ## [1] "3:2400 train loss : 0.581432, seg loss : 0.304436, accuracy : 0.969895"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:2400 test loss : 0.383737, accuracy : 0.983265"
    ## [1] "3:2700 train loss : 0.590583, seg loss : 0.324959, accuracy : 0.969685"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:2700 test loss : 0.384618, accuracy : 0.983274"
    ## [1] "3:3000 train loss : 0.612285, seg loss : 0.346379, accuracy : 0.970211"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:3000 test loss : 0.385491, accuracy : 0.983197"
    ## [1] "3:3300 train loss : 0.604633, seg loss : 0.313187, accuracy : 0.969474"
    ## [1] "아버지가방에들어가 셨다. "
    ## [1] "3:3300 test loss : 0.387478, accuracy : 0.983059"
    ## [1] "3:3600 train loss : 0.600186, seg loss : 0.321986, accuracy : 0.970106"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:3600 test loss : 0.386044, accuracy : 0.983153"
    ## [1] "3:3900 train loss : 0.598835, seg loss : 0.353271, accuracy : 0.970106"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:3900 test loss : 0.384619, accuracy : 0.983267"
    ## [1] "3:4200 train loss : 0.594936, seg loss : 0.301471, accuracy : 0.970106"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:4200 test loss : 0.384034, accuracy : 0.983250"
    ## [1] "3:4500 train loss : 0.595358, seg loss : 0.347148, accuracy : 0.969158"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:4500 test loss : 0.384356, accuracy : 0.983268"
    ## [1] "3:4800 train loss : 0.615266, seg loss : 0.346181, accuracy : 0.969895"
    ## [1] "아버지가방에 들어가셨다. "
    ## [1] "3:4800 test loss : 0.386773, accuracy : 0.983114"
    ## [1] "3:5100 train loss : 0.629860, seg loss : 0.301206, accuracy : 0.968421"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:5100 test loss : 0.383872, accuracy : 0.983279"
    ## [1] "3:5400 train loss : 0.580994, seg loss : 0.309080, accuracy : 0.969053"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:5400 test loss : 0.384740, accuracy : 0.983273"
    ## [1] "3:5700 train loss : 0.591630, seg loss : 0.321836, accuracy : 0.970000"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:5700 test loss : 0.383012, accuracy : 0.983296"
    ## [1] "3:6000 train loss : 0.594879, seg loss : 0.334301, accuracy : 0.969685"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:6000 test loss : 0.385272, accuracy : 0.983205"
    ## [1] "3:6300 train loss : 0.579580, seg loss : 0.261528, accuracy : 0.970106"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:6300 test loss : 0.384194, accuracy : 0.983252"
    ## [1] "3:6600 train loss : 0.605524, seg loss : 0.327113, accuracy : 0.969895"
    ## [1] "아버지가방에들어가셨다. "
    ## [1] "3:6600 test loss : 0.386164, accuracy : 0.983183"
    ## [1] "3:6900 train loss : 0.598934, seg loss : 0.302592, accuracy : 0.969263"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:6900 test loss : 0.384067, accuracy : 0.983176"
    ## [1] "3:7200 train loss : 0.617528, seg loss : 0.381794, accuracy : 0.969369"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:7200 test loss : 0.386287, accuracy : 0.983103"
    ## [1] "3:7500 train loss : 0.605818, seg loss : 0.349341, accuracy : 0.968527"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:7500 test loss : 0.383419, accuracy : 0.983328"
    ## [1] "3:7800 train loss : 0.605562, seg loss : 0.382935, accuracy : 0.970106"
    ## [1] "아버지가방에 들어가 셨다. "
    ## [1] "3:7800 test loss : 0.382047, accuracy : 0.983377"
    ## [1] "Model saved in file: model/model_3.chkp-1"

``` r
wsp$predict("사과배복숭아를사서집에갔다.",best_epoc = 3)
```

    ## [1] "사과 배복숭아를 사서 집에 갔다. "
